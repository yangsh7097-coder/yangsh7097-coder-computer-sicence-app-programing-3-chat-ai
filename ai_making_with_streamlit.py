# [ëª©ì ] ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¶•ì„ ìœ„í•œ Streamlit ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
# [ê²°ê³¼] íŒŒì´ì¬ ì½”ë“œë§Œìœ¼ë¡œ ì›¹ í˜ì´ì§€ì˜ UIì™€ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
import streamlit as st
# [ëª©ì ] Googleì˜ ê±°ëŒ€ ì–¸ì–´ ëª¨ë¸(Gemini)ì„ ì‚¬ìš©í•˜ì—¬ AI ì±—ë´‡ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
import google.generativeai as genai
# [ëª©ì ] ë°ì´í„° ì²˜ë¦¬ ë° ë¶„ì„ì„ ìœ„í•´ Pandasë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (í”¼ë“œë°± ì €ì¥ ì‹œ í™œìš©í•´ìš”.)
import pandas as pd
from datetime import datetime
import os

# --- 1. í˜ì´ì§€ ì„¤ì • ---
# [ëª©ì ] ì´ˆë“±í•™êµ 6í•™ë…„ í•™ìƒë“¤ì˜ í¥ë¯¸ë¥¼ ìœ ë°œí•˜ê¸° ìœ„í•´ 'íƒì •' ì»¨ì…‰ìœ¼ë¡œ í˜ì´ì§€ ì„¤ì •ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
# [ê²°ê³¼] ë¸Œë¼ìš°ì € íƒ­ ì œëª©ì´ ìš°ë¦¬ ì•„ì´ë“¤ì´ í¥ë¯¸ë¥¼ ëŠë‚„ë§Œí•œ "6í•™ë…„ ë°ì´í„° íƒì •"ìœ¼ë¡œ ë°”ë€Œê³ , ë‹ë³´ê¸° ì•„ì´ì½˜(ğŸ”)ì´ í‘œì‹œë©ë‹ˆë‹¤.
st.set_page_config(
    page_title="6í•™ë…„ ë°ì´í„° íƒì • ğŸ•µï¸â€â™€ï¸",
    page_icon="ğŸ”",
    layout="centered",
    initial_sidebar_state="auto"
)

# --- 2. ì»¤ìŠ¤í…€ CSS ---
# [ëª©ì ] ë³„ë„ì˜ CSS íŒŒì¼ì„ ë¡œë“œí•˜ì—¬ ì•± ì „ë°˜ì˜ ë””ìì¸(í°íŠ¸, ìƒ‰ìƒ, ì—¬ë°± ë“±)ì„ ì¼ê´€ì„± ìˆê²Œ ê¾¸ë°‰ë‹ˆë‹¤.(ë¬¼ë¡  ìŠ¤íŠ¸ë¦¼ë¦¿ ì•± ë‚´ë¶€ ì„¤ì •ìœ¼ë¡œ ìƒ‰ìƒì€ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.)
# [ê²°ê³¼] 'style.css'ì— ì •ì˜ëœ ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ì–´, ê¸°ë³¸ ë””ìì¸ë³´ë‹¤ ë” ê¹”ë”í•˜ê³  ëª°ì…ê° ìˆëŠ” í™”ë©´ì´ ë©ë‹ˆë‹¤.
def local_css(file_name):
    if os.path.exists(file_name):
        with open(file_name, encoding="utf-8") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

local_css("style.css")

# [ëª©ì ] ë©”ì¸ í™”ë©´ì˜ ì½˜í…ì¸  í­ì„ ì¡°ì ˆí•˜ì—¬, í•™êµ ë””ë²— íŒ¨ë“¤ë¦¿ í™”ë©´ì—ì„œë„ ê¸€ìê°€ ë„ˆë¬´ í¼ì ¸ ë³´ì´ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.(ì´ê²ƒë„ ë¬¼ë¡  ìŠ¤íŠ¸ë¦¼ë¦¿ ì•± ë‚´ë¶€ ê¸°ëŠ¥ìœ¼ë¡œ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
# [ê²°ê³¼] í…ìŠ¤íŠ¸ì™€ ì±„íŒ…ì°½ì´ í™”ë©´ ì¤‘ì•™ì— ì ì ˆí•œ ë„ˆë¹„ë¡œ ë°°ì¹˜ë˜ì–´ ê°€ë…ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
st.markdown("""
<style>
    .main .block-container {
        max-width: 800px;
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
</style>
""", unsafe_allow_html=True)

# Google Gemini API í‚¤ ì„¤ì •
# [ëª©ì ] ë³´ì•ˆì„ ìœ„í•´ ì†ŒìŠ¤ ì½”ë“œì— API í‚¤ë¥¼ ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•Šê³ , Streamlitì˜ Secrets ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.(ë¬¼ë¡  API í‚¤ëŠ” ë³´ì•ˆì„ ìœ„í•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.)
# [ê²°ê³¼] GitHubì— ì½”ë“œë¥¼ ì˜¬ë ¤ë„ API í‚¤ê°€ ìœ ì¶œë˜ì§€ ì•Šìœ¼ë©°, ì„œë²„ í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê²Œ í‚¤ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("Secretsì— GOOGLE_API_KEYë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")

# --- 3. ìˆ˜ì—… ë‚´ìš© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ---
# [ëª©ì ] AIì—ê²Œ '6í•™ë…„ ì •ë³´ ìˆ˜ì—… ë³´ì¡° êµì‚¬'ë¼ëŠ” í˜ë¥´ì†Œë‚˜(ì—­í• )ë¥¼ ë¶€ì—¬í•˜ê³ , ìˆ˜ì—…ì˜ ë§¥ë½ì„ í•™ìŠµì‹œí‚µë‹ˆë‹¤.
# [ê²°ê³¼] AIê°€ ë‹¨ìˆœíˆ ì •ë‹µë§Œ ë§í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í•™ìƒ ìˆ˜ì¤€ì— ë§ì¶° íŒíŠ¸ë¥¼ ì£¼ê³  íƒêµ¬ í™œë™ì„ ë•ëŠ” ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
LESSON_CONTEXT = """
# [AI í˜ë¥´ì†Œë‚˜: 6í•™ë…„ ì •ë³´ ìˆ˜ì—… ë³´ì¡° êµì‚¬ - ë°ì´í„° íƒì •]
ë‹¹ì‹ ì€ ì´ˆë“±í•™êµ 6í•™ë…„ ì •ë³´ ìˆ˜ì—…ì„ ë•ëŠ” ì¹œì ˆí•œ AI ë³´ì¡° êµì‚¬ì…ë‹ˆë‹¤. 
í•™ìƒë“¤ì´ 'ë””ì§€í„¸ ë°ì´í„°'ì™€ 'ì•„ë‚ ë¡œê·¸ ë°ì´í„°'ì˜ ì°¨ì´ë¥¼ ì´í•´í•˜ê³ , ì´ë¥¼ 'íŠ¸ë¦¬ ì•Œê³ ë¦¬ì¦˜'ìœ¼ë¡œ ë¶„ë¥˜í•˜ë©°, ì‚¬íšŒ ì† ë°ì´í„°ì˜ ìœ ìš©ì„±ì„ íƒêµ¬í•˜ëŠ” í™œë™ì„ ë•ìŠµë‹ˆë‹¤.

[ìˆ˜ì—… ëª©í‘œ]
ë°ì´í„°ì˜ ì¢…ë¥˜ì™€ ì˜ë¯¸ë¥¼ ì•Œê³ ë¦¬ì¦˜ì— ë”°ë¼ êµ¬ë³„í•œ í›„ ì‚¬íšŒ ì† ë°ì´í„°ì˜ ìœ ìš©ì„±ì„ ì´í•´í•  ìˆ˜ ìˆë‹¤.
íŠ¹íˆ, í•™ìƒë“¤ì´ ì„¸ìš´ 'ë¶„ë¥˜ ê¸°ì¤€(ì§ˆë¬¸)'ì´ ëª…í™•í•œì§€ ê²€ì¦í•´ì£¼ëŠ” ì—­í• ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

[ìˆ˜ì—… í™œë™ ë‹¨ê³„ë³„ ê°€ì´ë“œ]
1. í™œë™ 1 (ê°œë… ì´í•´): 
   - ì•„ë‚ ë¡œê·¸ ë°ì´í„°: ì‹œê°„ì´ íë¥´ë©´ì„œ ë³€í™”í•˜ëŠ” ê°’ì„ 'ì—°ì†ì 'ìœ¼ë¡œ í‘œí˜„ (ì˜ˆ: ìˆ˜ì€ ì˜¨ë„ê³„, ì•„ë‚ ë¡œê·¸ ì‹œê³„, ìš©ìˆ˜ì²  ì €ìš¸).
   - ë””ì§€í„¸ ë°ì´í„°: ëª…í™•í•œ ìˆ«ìë‚˜ ë¬¸ìë¡œ í‘œí˜„ë˜ë©° 'ì´ì‚°ì (ëšëš ëŠì–´ì§€ëŠ”)' í˜•íƒœ (ì˜ˆ: ì „ì ì²´ì˜¨ê³„, ë””ì§€í„¸ ì‹œê³„, ì „ì ì €ìš¸).
   - í•™ìƒì´ ë¬¼ê±´ì„ ì œì‹œí•˜ë©´ ì •ë‹µì„ ë°”ë¡œ ì£¼ì§€ ë§ê³ , "ê°’ì´ ì—°ì†ì ìœ¼ë¡œ ë³€í•˜ë‹ˆ, ì•„ë‹ˆë©´ ìˆ«ìë¡œ ë”± ë–¨ì–´ì§€ë‹ˆ?"ì™€ ê°™ì€ ë°œë¬¸ìœ¼ë¡œ ìŠ¤ìŠ¤ë¡œ êµ¬ë¶„í•˜ê²Œ ìœ ë„í•˜ì„¸ìš”.

2. í™œë™ 2 (ë¶„ë¥˜ ê²Œì„ - íŠ¸ë¦¬ ì•Œê³ ë¦¬ì¦˜):
   - í•™ìƒë“¤ì€ ì´ì ¤ íŒ¨ë“œì— íŠ¸ë¦¬ ì•Œê³ ë¦¬ì¦˜ì„ ê·¸ë¦½ë‹ˆë‹¤. ë‹¹ì‹ ì€ ê·¸ë“¤ì˜ 'ì§ˆë¬¸(ë¶„ë¥˜ ê¸°ì¤€)'ì„ ê²€ì¦í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
   - í•™ìƒì´ "ì´ ì§ˆë¬¸ ì–´ë•Œ?"ë¼ê³  ë¬¼ìœ¼ë©´, ê·¸ ì§ˆë¬¸ì´ 'ì˜ˆ/ì•„ë‹ˆì˜¤'ë¡œ ëª…í™•íˆ ë‚˜ë‰˜ëŠ”ì§€ íŒë‹¨í•´ ì£¼ì„¸ìš”.
   - Bad Question: "ì˜ˆìœê°€ìš”?", "ë¬´ê±°ìš´ê°€ìš”?" (ì£¼ê´€ì ì„) -> í”¼ë“œë°±: "ì‚¬ëŒë§ˆë‹¤ ê¸°ì¤€ì´ ë‹¬ë¼ìš”. '1kgë³´ë‹¤ ë¬´ê±°ìš´ê°€ìš”?'ì²˜ëŸ¼ êµ¬ì²´ì ìœ¼ë¡œ ë°”ê¿”ë³¼ê¹Œìš”?"
   - Good Question: "ìˆ«ìë¡œ í‘œí˜„ë˜ë‚˜ìš”?", "ì „ê¸°ë¥¼ ì‚¬ìš©í•˜ë‚˜ìš”?"
   - í•™ìƒì´ ë¶„ë¥˜ ê¸°ì¤€ì„ ì •í–ˆì„ ë•Œ, "ì™œ ê·¸ ê¸°ì¤€ì„ ê°€ì¥ ìƒìœ„ì— ë‘ì—ˆë‹ˆ?"ë¼ê³  ë¬¼ì–´ë³´ë©° í•™ìƒì˜ ë…¼ë¦¬ì  ì´ìœ (ë‚´ë©´í™” ì—¬ë¶€)ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.

3. í™œë™ 3 (ì‚¬íšŒ ìœµí•© - ë°ì´í„°ì˜ ìœ ìš©ì„±):
   - ê¸°ì—…: ì´ìœ¤ ì¶”êµ¬ë¥¼ ìœ„í•´ ì†Œë¹„ì ë°ì´í„°ë¥¼ í™œìš©í•¨ (ì˜ˆ: ë§ì¶¤í˜• ê´‘ê³ ).
   - ì •ë¶€: ê³µìµ ì¶”êµ¬ë¥¼ ìœ„í•´ êµ­ë¯¼ ë°ì´í„°ë¥¼ í™œìš©í•¨ (ì˜ˆ: êµí†µ íë¦„ ê°œì„ ).
   - "ì™œ ê¸°ì—…ì´ë‚˜ ì •ë¶€ê°€ ë°ì´í„°ë¥¼ ëª¨ì„ê¹Œ?"ë¼ëŠ” ì§ˆë¬¸ì„ í†µí•´ í•™ìƒë“¤ì´ ì‚¬íšŒì  ì˜ë¯¸ë¥¼ ì°¾ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
   - ê¸°ì—…ì˜ ë°ì´í„° í™œìš©ì— ëŒ€í•´ ì´ì•¼ê¸°í•  ë•Œ, íš¨ìœ¨ì„±ë¿ë§Œ ì•„ë‹ˆë¼ 'ê°œì¸ì •ë³´ ë³´í˜¸'ë‚˜ 'ë°ì´í„° ì£¼ê¶Œ' ê°™ì€ ìœ¤ë¦¬ì  ë¬¸ì œë„ í•¨ê»˜ ìƒê°í•´ë³´ë„ë¡ ì§ˆë¬¸ì„ ë˜ì ¸ì£¼ì„¸ìš”.

[ë‹¹ì‹ ì˜ ì—­í•  ë° í–‰ë™ ì§€ì¹¨]
ë§íˆ¬ëŠ” ì´ˆë“±í•™êµ 6í•™ë…„ ìˆ˜ì¤€ì— ë§ì¶° ì¹œì ˆí•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•˜ë©°, ì •ë‹µì„ ë°”ë¡œ ì•Œë ¤ì£¼ê¸°ë³´ë‹¤ íŒíŠ¸ë¥¼ ì£¼ì–´ ì‚¬ê³ ë¥¼ í™•ì¥ì‹œì¼œ ì£¼ì„¸ìš”.
í•™ìƒë“¤ì´ AIì˜ ë‹µë³€ì„ ë¬´ë¹„íŒì ìœ¼ë¡œ ìˆ˜ìš©í•˜ì§€ ì•Šë„ë¡, ê°€ë” "ì„ ìƒë‹˜ì´ë‚˜ êµê³¼ì„œ ë‚´ìš©ê³¼ë„ ë¹„êµí•´ë´!"ë¼ê³  ì¡°ì–¸í•´ ì£¼ì„¸ìš”.
ë˜í•œ, í•™ìƒì´ ë…¼ë¦¬ì ìœ¼ë¡œ íƒ€ë‹¹í•œ ì§ˆë¬¸(ë¶„ë¥˜ ê¸°ì¤€)ì„ ë§Œë“¤ì—ˆì„ ë•ŒëŠ” "ì •ë§ í›Œë¥­í•œ ì§ˆë¬¸ì´ì•¼! ëª…í™•í•˜ê²Œ ì˜ ë‚˜ëˆ„ì—ˆì–´."ì™€ ê°™ì´ ì¦‰ê°ì ì¸ ì¹­ì°¬(ê°•í™”)ì„ í•´ì£¼ì„¸ìš”.
í•­ìƒ ì´ˆë“±í•™ìƒì—ê²Œ ì í•©í•œ ê±´ì „í•˜ê³  êµìœ¡ì ì¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ë©°, í¸í–¥ë˜ê±°ë‚˜ ìœ í•´í•œ ë‚´ìš©ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
í•™ìƒì´ ì§ˆë¬¸ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ë‹¤ì‹œ ë¬¼ì–´ë³¼ ë•Œ, "ì•„ê¹Œ ì§ˆë¬¸ì´ë‘ ì–´ë–»ê²Œ ë‹¤ë¥´ê²Œ ìƒê°í–ˆë‹ˆ?" ë˜ëŠ” "ì™œ ê·¸ë ‡ê²Œ ìƒê°í–ˆì–´?"ë¼ê³  ë¬¼ì–´ë´ì„œ í•™ìƒ ìŠ¤ìŠ¤ë¡œ ìƒê°í•˜ëŠ” ê³¼ì •(ë©”íƒ€ì¸ì§€)ì„ ê¸°ë¡í•˜ê²Œ ë„ì™€ì£¼ì„¸ìš”.
"""

# --- 4. ëª¨ë¸ ë¡œë“œ í•¨ìˆ˜ ---
@st.cache_resource
# [ëª©ì ] AI ëª¨ë¸ì„ ë§¤ë²ˆ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ë©´ ì†ë„ê°€ ëŠë ¤ì§€ë¯€ë¡œ, í•œ ë²ˆ ë¶ˆëŸ¬ì˜¨ ëª¨ë¸ì„ ë©”ëª¨ë¦¬ì— ì €ì¥(ìºì‹±)í•´ë‘¡ë‹ˆë‹¤.
# [ê²°ê³¼] ì²« ì‹¤í–‰ ì´í›„ì—ëŠ” ëª¨ë¸ ë¡œë”© ì‹œê°„ ì—†ì´ ì¦‰ì‹œ ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ìˆì–´ ì•± ì„±ëŠ¥ì´ í–¥ìƒë©ë‹ˆë‹¤.
def load_model():
    model = genai.GenerativeModel(
        model_name='gemini-2.5-flash', 
        system_instruction=LESSON_CONTEXT 
    )
    return model

# --- 5. í”¼ë“œë°± ì €ì¥ í•¨ìˆ˜ (ë³€ìˆ˜ëª… chat_logë¡œ ë³€ê²½) ---
# [ëª©ì ] í•™ìƒë“¤ì˜ ë°˜ì‘(ì¢‹ì•„ìš”/ì•„ì‰¬ì›Œìš”)ê³¼ êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ìˆ˜ì§‘í•˜ì—¬ ìˆ˜ì—… ê°œì„  ìë£Œë¡œ í™œìš©í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
# [ê²°ê³¼] 'feedback.csv' íŒŒì¼ì— ë‚ ì§œ, ì§ˆë¬¸, ë‹µë³€, í‰ê°€ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ í•œ ì¤„ì”© ì¶”ê°€ë©ë‹ˆë‹¤.
def save_feedback(message_index, rating, feedback_text=""):
    # chat_logë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
    if message_index > 0:
        user_question = st.session_state.chat_log[message_index - 1]['content']
    else:
        user_question = "" 

    ai_answer = st.session_state.chat_log[message_index]['content']

    feedback_data = {
        "timestamp": [datetime.now().strftime("%Y-%m-%d %H:%M:%S")],
        "user_question": [user_question],
        "ai_answer": [ai_answer],
        "rating": [rating],
        "feedback_text": [feedback_text]
    }
    df = pd.DataFrame(feedback_data)

    if os.path.exists("feedback.csv"):
        df.to_csv("feedback.csv", mode='a', header=False, index=False, encoding='utf-8-sig')
    else:
        df.to_csv("feedback.csv", mode='w', header=True, index=False, encoding='utf-8-sig')

# [ëª©ì ] Streamlitì˜ ì—­í• ëª…('assistant')ì„ Gemini APIê°€ ì´í•´í•˜ëŠ” ì—­í• ëª…('model')ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
def translate_role_for_gemini(role):
    return "model" if role == "assistant" else role

# --- 6. ì‚¬ì´ë“œë°” ---
with st.sidebar:
    # [ëª©ì ] ë©”ì¸ í™”ë©´ ì™¸ì— ë¶€ê°€ì ì¸ ê¸°ëŠ¥(ì•ˆë‚´, íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë“±)ì„ ë°°ì¹˜í•  ê³µê°„ì„ ë§Œë“­ë‹ˆë‹¤.
    st.header("ğŸ•µï¸â€â™€ï¸ ìˆ˜ì—… ë„ìš°ë¯¸")
    st.info("6í•™ë…„ 1ë°˜ ì¹œêµ¬ë“¤ í™˜ì˜í•©ë‹ˆë‹¤!\në°ì´í„°ì˜ ë¹„ë°€ì„ í•¨ê»˜ íŒŒí—¤ì³ë´ìš”.")
    
    # [ê¸°ëŠ¥ ì¶”ê°€] ìˆ˜ì—…ì§€ë„ì•ˆ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    # [ëª©ì ] ë¬¼ë¡  ìˆ˜ì—…ì—ì„œëŠ” ì•ˆì“°ê² ì§€ë§Œ, ê³¼ì œì—ì„œ íŠ¹ë³„íˆ ìˆ˜ì—…ê³„íšì„ ì œì¶œí•´ì•¼ í•  ë•Œ í‰ê°€ì(êµìˆ˜ë‹˜)ë‚˜ ë™ë£Œ êµì‚¬ê°€ ì´ ì•±ì˜ êµìœ¡ì  í™œìš© ê³„íšì„ ì¦‰ì‹œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
    # [ê²°ê³¼] 'ìˆ˜ì—…ì§€ë„ì•ˆ ë‹¤ìš´ë¡œë“œ' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ PDF íŒŒì¼ì´ ì‚¬ìš©ì ì»´í“¨í„°ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.
    st.markdown("---")
    st.subheader("ğŸ“‚ ìë£Œì‹¤")
    
    # [ëª©ì ] í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ íŒŒì´ì¬ íŒŒì¼ì˜ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ lesson_plan.pdf ê²½ë¡œë¥¼ ì •í™•íˆ ì°¾ìŠµë‹ˆë‹¤.
    current_dir = os.path.dirname(os.path.abspath(__file__))
    lesson_file_path = os.path.join(current_dir, "lesson_plan.pdf")
    
    if os.path.exists(lesson_file_path):
        with open(lesson_file_path, "rb") as f:
            st.download_button(
                label="ğŸ“„ ìˆ˜ì—…ì§€ë„ì•ˆ ë‹¤ìš´ë¡œë“œ (PDF)",
                data=f,
                file_name="6í•™ë…„_ì •ë³´ìˆ˜ì—…_ì§€ë„ì•ˆ.pdf",
                mime="application/pdf"
            )
    else:
        st.warning("ìˆ˜ì—…ì§€ë„ì•ˆ íŒŒì¼ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    if st.button("ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°", use_container_width=True):
        # [ëª©ì ] ì´ì „ ëŒ€í™” ë‚´ìš©ì´ ë‚¨ì§€ ì•Šë„ë¡ ëŒ€í™” ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì—¬ ìƒˆë¡œìš´ ìˆ˜ì—…ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
        # [ê²°ê³¼] í™”ë©´ì´ ìƒˆë¡œê³ ì¹¨ë˜ë©´ì„œ ì±„íŒ…ì°½ì´ ê¹¨ë—í•˜ê²Œ ë¹„ì›Œì§‘ë‹ˆë‹¤.
        st.session_state.chat_log = [] 
        st.rerun()
    
    # ëŒ€í™” ë‚´ìš© ë‹¤ìš´ë¡œë“œ
    # [ëª©ì ] í•™ìƒë“¤ì´ AIì™€ ë‚˜ëˆˆ ëŒ€í™” ë‚´ìš©ì„ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ë‚˜ ë³µìŠµ ìë£Œë¡œ ì“°ê²Œ í•©ë‹ˆë‹¤.
    if st.session_state.get("chat_log"):
        chat_history = "\n\n".join(
            f"**{m['role'].capitalize()}**: {m['content']}" 
            for m in st.session_state.chat_log
        )
        st.download_button(
            label="ì˜¤ëŠ˜ì˜ íƒêµ¬ ê¸°ë¡ ì €ì¥",
            data=chat_history.encode('utf-8'),
            file_name="data_class_log.txt",
            mime="text/plain",
            use_container_width=True
        )

# --- 7. ë©”ì¸ UI ---
st.title("ğŸ•µï¸â€â™€ï¸ ë°ì´í„° íƒì • ì±—ë´‡")
st.caption("6í•™ë…„ ì •ë³´-ì‚¬íšŒ ìœµí•© ìˆ˜ì—…: ë””ì§€í„¸ vs ì•„ë‚ ë¡œê·¸")

# [ëª©ì ] ìœ¤ë¦¬ì  ê³ ë ¤ì‚¬í•­(í• ë£¨ì‹œë„¤ì´ì…˜)ì„ ë°˜ì˜í•˜ì—¬, í•™ìƒë“¤ì—ê²Œ AI ë‹µë³€ì˜ í•œê³„ë¥¼ ë¯¸ë¦¬ ì•Œë¦½ë‹ˆë‹¤.
# [ê²°ê³¼] í•™ìƒë“¤ì´ AIë¥¼ ë§¹ì‹ í•˜ì§€ ì•Šê³  ë¹„íŒì ìœ¼ë¡œ ì •ë³´ë¥¼ ìˆ˜ìš©í•˜ëŠ” íƒœë„ë¥¼ ê°–ê²Œ ë©ë‹ˆë‹¤.
st.info("ğŸ“¢ **ì£¼ì˜ì‚¬í•­:** íƒì • ì¡°ìˆ˜(AI)ë„ ê°€ë” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆì–´ìš”! ë‹µë³€ì´ ì´ìƒí•˜ë©´ ê¼­ ì„ ìƒë‹˜ê»˜ ì—¬ì­¤ë³´ê±°ë‚˜ êµê³¼ì„œë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”.")

chat_container = st.container(height=500)

with chat_container:
    # [ëª©ì ] ì›¹ ì•±ì´ ìƒˆë¡œê³ ì¹¨ë˜ì–´ë„ ëŒ€í™” ë‚´ìš©ì´ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ 'session_state'ì— ëŒ€í™” ê¸°ë¡ì„ ì €ì¥í•©ë‹ˆë‹¤.
    if "chat_log" not in st.session_state:
        # [ëª©ì ] ì•± ì ‘ì† ì‹œ í•™ìƒë“¤ì—ê²Œ AIì˜ ì—­í• ê³¼ ì‚¬ìš©ë²•ì„ ì•ˆë‚´í•˜ëŠ” ì²« ì¸ì‚¬ë¥¼ ê±´ë„µë‹ˆë‹¤.
        welcome_msg = "ì•ˆë…•! ë‚˜ëŠ” ë°ì´í„° íƒì • ì¡°ìˆ˜ì•¼. ğŸ•µï¸\n\n**'ì•„ë‚ ë¡œê·¸'**ì™€ **'ë””ì§€í„¸'**ì´ ë¬´ì—‡ì¸ì§€ ê¶ê¸ˆí•˜ê±°ë‚˜, **íŠ¸ë¦¬ ì•Œê³ ë¦¬ì¦˜** ë§Œë“œëŠ” ê²Œ ì–´ë ¤ìš°ë©´ ë‚˜ì—ê²Œ ë¬¼ì–´ë´ ì¤˜!"
        st.session_state.chat_log = [{"role": "assistant", "content": welcome_msg}]

    # [ëª©ì ] ì €ì¥ëœ ëŒ€í™” ê¸°ë¡ì„ ìˆœì„œëŒ€ë¡œ í™”ë©´ì— í‘œì‹œí•˜ì—¬, ì¹´ì¹´ì˜¤í†¡ì²˜ëŸ¼ ëŒ€í™”ê°€ ì´ì–´ì§€ëŠ” UIë¥¼ ë§Œë“­ë‹ˆë‹¤.
    for idx, message in enumerate(st.session_state.chat_log):
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

            if message["role"] == "assistant":
                feedback_key_base = f"feedback_{idx}"
                col1, col2, _ = st.columns([1, 1, 8])
                with col1:
                    if st.button("ğŸ‘", key=f"{feedback_key_base}_like"):
                        save_feedback(idx, "ğŸ‘ ì¢‹ì•˜ì–´ìš”")
                        st.toast("ë„ì›€ì´ ë˜ì—ˆë‹¤ë‹ˆ ë‹¤í–‰ì´ì•¼! ğŸ˜Š")
                with col2:
                    if st.button("ğŸ‘", key=f"{feedback_key_base}_dislike"):
                        st.session_state[f"show_feedback_input_{idx}"] = True
                
                if st.session_state.get(f"show_feedback_input_{idx}"):
                    feedback_text = st.text_area("ì–´ë–¤ ì ì´ ì–´ë ¤ì› ë‹ˆ?", key=f"{feedback_key_base}_text")
                    if st.button("ë³´ë‚´ê¸°", key=f"{feedback_key_base}_submit"):
                        save_feedback(idx, "ğŸ‘ ì•„ì‰¬ì›Œìš”", feedback_text)
                        st.toast("ì˜ê²¬ ê³ ë§ˆì›Œ! ë” ì—´ì‹¬íˆ ê³µë¶€í• ê²Œ. ğŸ™‡â€â™‚ï¸")
                        st.session_state[f"show_feedback_input_{idx}"] = False

# --- 8. ì±—ë´‡ êµ¬ë™ ë¡œì§ ---
if prompt := st.chat_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."):
    # [ëª©ì ] ì‚¬ìš©ìê°€ ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ ë„£ìœ¼ë©´, ì´ë¥¼ í™”ë©´ì— ì¦‰ì‹œ ë³´ì—¬ì£¼ê³  ëŒ€í™” ê¸°ë¡ì— ì¶”ê°€í•©ë‹ˆë‹¤.
    st.session_state.chat_log.append({"role": "user", "content": prompt})
    with chat_container:
        with st.chat_message("user"):
            st.markdown(prompt)

    # [ëª©ì ] AIì—ê²Œ ì§ˆë¬¸ì„ ì „ë‹¬í•˜ê³ , ë‹µë³€ì´ ìƒì„±ë˜ëŠ” ê³¼ì •ì„ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    with chat_container:
        with st.chat_message("assistant"):
            response_container = st.empty()
            
            try:
                model = load_model()
                # chat_logë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìš”ì²­ ë©”ì‹œì§€ ìƒì„±
                gemini_messages = [
                    {"role": translate_role_for_gemini(m["role"]), "parts": [m["content"]]} 
                    for m in st.session_state.chat_log
                ]
                
                # ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­
                response = model.generate_content(gemini_messages, stream=True)
                
                # [ê²°ê³¼] AIê°€ ë‹µë³€ì„ í•œ ê¸€ìì”© íƒ€ì ì¹˜ë“¯ ì¶œë ¥í•˜ì—¬, ì‚¬ìš©ìê°€ ê¸°ë‹¤ë¦¬ëŠ” ì§€ë£¨í•¨ì„ ëœì–´ì¤ë‹ˆë‹¤.
                full_response = ""
                for chunk in response:
                    if chunk.text:
                        full_response += chunk.text
                        response_container.markdown(full_response)
                
                # [ëª©ì ] ì™„ì„±ëœ AIì˜ ë‹µë³€ì„ ëŒ€í™” ê¸°ë¡ì— ì €ì¥í•˜ì—¬, ë‹¤ìŒ ì§ˆë¬¸ì—ì„œë„ ë¬¸ë§¥ì„ ê¸°ì–µí•˜ê²Œ í•©ë‹ˆë‹¤.
                st.session_state.chat_log.append({"role": "assistant", "content": full_response})

            except Exception as e:
                # ì˜¤ë¥˜ê°€ ë‚˜ë©´ ë¹¨ê°„ ê¸€ì”¨ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
                response_container.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
                # í˜¹ì‹œ ì—ëŸ¬ê°€ ë‚¬ì„ ë•Œë¥¼ ëŒ€ë¹„í•´ ë§ˆì§€ë§‰ ì§ˆë¬¸ ê¸°ë¡ì„ ì§€ì›Œ ê¼¬ì„ì„ ë°©ì§€í•©ë‹ˆë‹¤.
                st.session_state.chat_log.pop()